%   Returns a set of function handles corresponding to the flat plate wing
%   map of unit length corresponding to annulus of interior radius q.
%   
%   Cite: Exact solutions for ground effect, P. J. Baddoo, M. Kurt, L. J.
%         Ayton, K. W. Moored, JFM Rapids, 2020


function [f,fd,fdd,a,zt] = flatWing(alpha,q)

N = [1e3,1e2];
% Present the inital map
map = @(zVar) P(zVar.*exp(2i*alpha),q,N)./P(zVar,q,N);

% Differentiate initial map twice
mapd  = @(zVar) exp(2i*alpha)*Pd(zVar.*exp(2i*alpha),q,N)./P(zVar,q,N) ...
                  -P(zVar.*exp(2i*alpha),q,N).*Pd(zVar,q,N)./P(zVar,q,N).^2;
mapdd = @(zVar)   -2*exp(2i*alpha)*Pd(zVar.*exp(2i*alpha),q,N).*Pd(zVar,q,N)./P(zVar,q,N).^2 ...
                  + exp(4i*alpha)*Pdd(zVar,q,N)./P(zVar,q,N)...
                  +P(zVar.*exp(2i*alpha),q,N).*(2*Pd(zVar,q,N).^2./P(zVar,q,N).^3 - Pdd(zVar,q,N)./P(zVar,q,N).^2);

% Find zeros of derivative (correspond to pre-images locations of leading
% and trailing edges.
f = @(th) abs(mapd(q*exp(1i*th))); 
fp = @(th) real(mapd(q*exp(1i*th)).*conj(1i*q*exp(1i*th).*mapdd(q*exp(1i*th))))./abs(mapd(q*exp(1i*th)));
% Set tolerance for root finding
tol = 1e-10;

thv(1) = mod(myNewton(f,fp,0,tol),2*pi);
% Now extract found root from function with smooth regulariser. Note that
% the function is now singular at the first found root.
f1 = @(th) f(th)./abs(sin((th-modthv(1)));
f1p= @(th) (fp(th).*(1-cos(th-thv(1)))-f(th).*sin(th-thv(1)))./(1-cos(th-thv(1))).^2;
thv(2) = myNewton(f1,f1p,thv(1)+.1,tol);

% Sort zeros into leading and trailing edges
A1 = sign(-alpha)*exp(-1i*alpha);
[~,ind] = sort(real(A1*map(q.*exp(1i*thv))));
zt = q*exp(1i*thv(ind));

% Find length of plate to rescale
plateLength = abs(diff(A1*map(zt)));
A =  A1./plateLength; s = -real(A*map(zt(1)));

% Find shift distance
f   = @(zVar) A*map(zVar) + s;
fd  = @(zVar) A*mapd(zVar);
fdd = @(zVar) A*mapdd(zVar);

L = 1;
a = A*P(exp(2i*alpha))./L;

end